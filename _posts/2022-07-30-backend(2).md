---
layout: single
title: "ì›¹ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìê°€ ì•Œì•„ì•¼ í•  ìµœì†Œí•œì˜ ë°±ì—”ë“œ ì§€ì‹(2)"
categories: Back-end
tag: express.js
author_profile: false
sidebar:
  nav: "docs"
# search: false
toc: true
---

**[ê³µì§€ì‚¬í•­]** ì˜ëª»ëœ ì •ë³´ë‚˜ ì˜¤íƒ€ì— í”¼ë“œë°± ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.:)
{: .notice--info}

# ğŸ” ê°œìš”

ë¡œê·¸ì¸ ê´€ë ¨ ì§€ì‹ì„ ë°°ì›Œë³´ê³ ì í•œë‹¤.

# user

```js
const express = require("express");
const app = express();
const port = 3000;

app.use(express.json());
// cookie-parser ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡
app.use(cookieParser());
app.use(express.urlencoded({ extended: false }));

const database = {
  {id: 1, username: 'test1', password: 'test1', birthday: '2000-01-01'},
};

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

## íšŒì›ê°€ì…

ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”ë¥¼ ìœ„í•´ argon2 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í–ˆë‹¤.

```js
app.post("/signup", (req, res) => {
  const { username, password, age, birthday } = req.body;

  const hash = await argon2.hash(password);

  database.push({
    username,
    password: hash,
    age,
    birthday,
  });
  res.send("complete");
});
```

## ë¡œê·¸ì¸

```js
app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  const user = database.filter((user) => {
    return user.username === username;
  });

  if (user.length === 0) {
    res.status(403);
    res.send("í•´ë‹¹í•˜ëŠ” IDê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (!(await argon2.verify(user[0].password, password))) {
    res.status(403);
    res.send("íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë¦½ë‹ˆë‹¤.");
    return;
  }

  res.send("complete");
});
```

## íšŒì›íƒˆí‡´

```js
app.delete("/users", (req, res) => {
  ...
})
```

# auth

## 1. state ful

ë¡œê·¸ì¸í•œ ìœ ì €ê°€ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ë¥¼ ì„œë²„ê°€ ê´€ë¦¬í•˜ëŠ” ê²ƒ.

ì‚¬ìš©ìê°€ ì˜ˆìƒí•˜ì§€ ëª»í•˜ê²Œ ë§ì•„ì§„ë‹¤ë©´, ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•´ì ¸ ì»´í“¨íŒ…ì— ë¹„ìš©ì„ ì¶”ê°€ë¡œ ì§€ë¶ˆí•´ì•¼ í•œë‹¤.

## 2. stateless

ì„œë²„ê°€ access_tokenì„ ë°œê¸‰í•˜ê³  í´ë¼ì´ì–¸íŠ¸ê°€ ê°–ê³  ìˆëŠ” ê²ƒ.

í† í° ë°œê¸‰ì„ ìœ„í•´ `jsonwebtoken` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í–ˆë‹¤.

ë¡œê·¸ì¸ ë¶€ë¶„ì— ì ìš©

```js
// í† í°ì„ ìƒì„±
const access_token = jwt.sign({ username }, "secure");
```

í† í°ì„ ë„˜ê²¨ì£¼ëŠ” ë°©ì‹ì€ 2ê°€ì§€ê°€ ìˆë‹¤.

- ì¿ í‚¤ë¥¼ ì´ìš©í•´ì„œ ë„˜ê²¨ì£¼ê¸°

  ```js
  res.cookie("access_token", access_token);
  ```

- responseì— ì‹¤ì–´ì„œ ë„˜ê²¨ì£¼ê¸°

  ë‹¤ìŒì— ì•Œì•„ë³´ê² ë‹¤.

# ì „ì²´ ì½”ë“œ

```js
const express = require("express");
const argon2 = require("argon2");
const jwt = require("jsonwebtoken");
const cookieParser = require("cookieParser");
const { accessTokenVerify } = require("./middleware");
const app = express();
const port = 3000;

app.use(express.json());
// cookie-parser ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡
app.use(cookieParser());
app.use(express.urlencoded({ extended: false }));

const database = [
  { id: 1, username: "test1", password: "test1", birthday: "2000-01-01" },
];

app.get("/secure_data", (req, res) => {
  const { access_token } = req.cookies;
  if (!access_token) {
    res.status(401).send("access tokenì´ ì—†ìŠµë‹ˆë‹¤.");
  }

  try {
    const { username } = jwt.verify(access_token, "secure");
    const userInfo = database.find((data) => data.username === username);

    if (!userInfo) {
      throw "userInfoê°€ ì—†ìŠµë‹ˆë‹¤.";
    }
    res.send("ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì“¸ ìˆ˜ ìˆëŠ” API");
  } catch (err) {
    res.status(401).send("ìœ íš¨í•œ access tokenì´ ì•„ë‹™ë‹ˆë‹¤.");
  }
});

app.post("/signup", async (req, res) => {
  const { username, password, age, birthday } = req.body;
  const hash = await argon2.hash(password);

  database.push({
    username,
    password: hash,
    age,
    birthday,
  });
  res.send("success");
});

app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  const user = database.filter((user) => {
    return user.username === username;
  });

  if (user.length === 0) {
    res.status(403).send("í•´ë‹¹í•˜ëŠ” IDê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (!(await argon2.verify(user[0].password, password))) {
    res.status(403).send("íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë¦½ë‹ˆë‹¤.");
    return;
  }

  const access_token = jwt.sign({ username }, "secure");
  res.cookie("access_token", access_token, {
    httpOnly: true,
  });
  res.send("complete");
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

## middleware ì‚¬ìš©

middlewareëŠ” HTTP ìš”ì²­ê³¼ ì‘ë‹µ ì‚¬ì´ì—ì„œ ë‹¨ê³„ë³„ ë™ì‘ì„ ìˆ˜í–‰í•´ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.

1. middleware í´ë” ìƒì„±
2. auth.js íŒŒì¼ ìƒì„±

```js
// auth.js
const { database } = require("../database");
const jwt = require("jsonwebtoken");

const validUser = (req, res, next) => {
  const { access_token } = req.cookies;
  if (!access_token) {
    res.status(401).send("access tokenì´ ì—†ìŠµë‹ˆë‹¤.");
  }

  try {
    const { username } = jwt.verify(access_token, "secure");
    const userInfo = database.find((data) => data.username === username);

    if (!userInfo) {
      throw "userInfoê°€ ì—†ìŠµë‹ˆë‹¤.";
    }

    next(); // ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
  } catch (err) {
    res.status(401).send("ìœ íš¨í•œ access tokenì´ ì•„ë‹™ë‹ˆë‹¤.");
  }
};
```

```js
// app.js
const express = require("express");
const argon2 = require("argon2");
const jwt = require("jsonwebtoken");
const cookieParser = require("cookieParser");
const { accessTokenVerify } = require("./middleware");
const { validUser } = require("./middleware/auth");
const database = require("./database");
const app = express();
const port = 3000;

app.use(express.json());
// cookie-parser ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡
app.use(cookieParser());
app.use(express.urlencoded({ extended: false }));

app.get("/secure_data", validUser, (req, res) => {
  res.send("ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì“¸ ìˆ˜ ìˆëŠ” API");
});

app.post("/signup", async (req, res) => {
  const { username, password, age, birthday } = req.body;
  const hash = await argon2.hash(password);

  database.push({
    username,
    password: hash,
    age,
    birthday,
  });
  res.send("success");
});

app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  const user = database.filter((user) => {
    return user.username === username;
  });

  if (user.length === 0) {
    res.status(403);
    res.send("í•´ë‹¹í•˜ëŠ” IDê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (!(await argon2.verify(user[0].password, password))) {
    res.status(403);
    res.send("íŒ¨ìŠ¤ì›Œë“œê°€ í‹€ë¦½ë‹ˆë‹¤.");
    return;
  }

  const access_token = jwt.sign({ username }, "secure");
  res.cookie("access_token", access_token, {
    httpOnly: true,
  });
  res.send("complete");
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

```js
// database.js
const database = [
  { id: 1, username: "test1", password: "test1", birthday: "2000-01-01" },
];

module.exports = database;
```

# ğŸ“ƒ ì°¸ê³ 

## argon2

ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ ë¼ì´ë¸ŒëŸ¬ë¦¬

### ì‚¬ìš©ë²•

ì„¤ì¹˜ í›„,

```js
const argon2 = require("argon2");

// ì•”í˜¸í™”
try {
  const hash = await argon2.hash("password");
} catch (err) {
  //...
}

// ë³µí˜¸í™”
try {
  if (await argon2.verify("<big long hash>", "password")) {
    // password match
  } else {
    // password did not match
  }
} catch (err) {
  // internal failure
}
```

## jsonwebtoken

í† í°ì„ ì œê³µí•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

### ì‚¬ìš©ë²•

ì„¤ì¹˜ í›„,

```js
const jwt = require("jsonwebtoken");

const token = jwt.sign({ foo: "bar" }, "shhhhh");
```

## cookie-parser

í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„í•œí…Œ ì¿ í‚¤ê°’ì„ ì‰½ê²Œ ìš”ì²­í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

### ì‚¬ìš©ë²•

ì„¤ì¹˜ í›„,

```js
const cookieParser = require("cookie-parser");
```

## httpOnly

í´ë¼ì´ì–¸íŠ¸ ì¸¡ì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ê°ì‹¸ì—¬ì§„(ë³´í˜¸ëœ) ì¿ í‚¤ì— ì ‘ê·¼í• ë•Œ ìœ„í—˜ì„ ì™„í™”ì‹œí‚¤ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

### ì‚¬ìš©ë²•

```js
res.cookie("access_token", access_token, {
  httpOnly: true,
});
```

# ğŸ’­ ëŠë‚€ ì 

ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ë‚´ê°€ êµ¬í˜„í•´ë³´ê³  ì‹¶ì—ˆëŠ”ë° ê·¸ ë¶€ë¶„ì„ í•´ê²°í•˜ê²Œ ë˜ëŠ” ì¢‹ì€ ì‹œê°„ì´ì—ˆë‹¤.

---

ì¶œì²˜

- [https://www.youtube.com/watch?v=bnbf1E65w6A&t=3s](https://www.youtube.com/watch?v=bnbf1E65w6A&t=3s)
